
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>配達上限登録</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --border:#c9cfd6;
    --header:#eef5f9;
    --danger:#c0392b;
    --muted:#f7f3ef;
    --sunday:#fbe9e9;
  }
  body{
    font-family: "Segoe UI","Yu Gothic","Meiryo",sans-serif;
    background:#f6f4ee;
    margin:0; padding:24px; color:#333;
  }
  .page{
    max-width:900px; margin:0 auto; background:#fff; border:1px solid var(--border);
    border-radius:10px; padding:22px;
    box-shadow:0 3px 10px rgba(0,0,0,.06);
  }
  h1{ margin:0 0 10px; font-size:22px; }
  .controls{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:14px;
  }
  select, button, input[type="number"]{
    font-size:16px; padding:8px 10px; border:1px solid var(--border); border-radius:8px;
    background:#fff;
  }
  .monthBadge{
    background:#e8f6fb; border:1px solid #b7d9e9; border-radius:8px; padding:8px 12px;
    min-width:140px; text-align:center; font-weight:600;
  }
  .tableWrap{ overflow:auto; border:1px solid var(--border); border-radius:8px; }
  table{ border-collapse:collapse; width:100%; min-width:680px; }
  thead th{
    background:var(--header); border-bottom:1px solid var(--border); padding:10px; text-align:center;
    position:sticky; top:0; z-index:1;
  }
  tbody td{ border-top:1px solid var(--border); padding:8px 10px; }
  tbody tr:nth-child(odd){ background:#fff; }
  tbody tr:nth-child(even){ background:#fafafa; }
  .dateCell{ white-space:nowrap; }
  .dowCell{ text-align:center; width:64px; }
  .capCell{ width:160px; }
  .capInput{
    width:120px; padding:6px 8px; text-align:right;
  }
  .sunRow{ background:var(--sunday); }
  .disabled input{ background:#eee; color:#999; pointer-events:none; }
  .legend{ margin:8px 0 14px; color:#666; font-size:14px; }
  .actions{ display:flex; gap:12px; justify-content:center; margin-top:16px; flex-wrap:wrap; }
  .error{ display:none; background:var(--danger); color:#fff; padding:10px 12px; border-radius:8px; margin-top:12px; }
  .success{ display:none; background:#d6f6e8; color:#114; padding:10px 12px; border-radius:8px; margin-top:12px; }
  .back{ background:#fff; }
  .save{ background:#ecfff8; border-color:#9bd4cc; }
  .sr-only{
    position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden;
    clip:rect(0,0,0,0); border:0;
  }
</style>
</head>
<body>
<div class="page">
  <h1>⑥ 配達上限登録</h1>

  <!-- 操作バー -->
  <div class="controls">
    <button type="button" class="back" onclick="history.back()">戻る</button>

    <span>対象年月：</span>
    <label class="sr-only" for="yearSel">年</label>
    <select id="yearSel"></select>
    <label class="sr-only" for="monthSel">月</label>
    <select id="monthSel"></select>

    <span class="monthBadge" id="monthBadge"></span>

    <button type="button" id="decideBtn">決定</button>
  </div>

  <div class="legend">※ 1か月分を表示。<strong>日曜</strong>は入力不可（設定で変更可能）。午前/午後は「0以上の整数」で入力してください。</div>

  <!-- 表 -->
  <div class="tableWrap">
    <table id="capTable" aria-label="配達上限登録表">
      <thead>
        <tr>
          <th scope="col">日付</th>
          <th scope="col">曜日</th>
          <th scope="col">午前</th>
          <th scope="col">午後</th>
        </tr>
      </thead>
      <tbody id="capBody">
        <!-- 行は JS で生成 -->
      </tbody>
    </table>
  </div>

  <!-- メッセージ -->
  <div id="errorBox" class="error" role="alert"></div>
  <div id="successBox" class="success" role="status"></div>

  <!-- アクション -->
  <div class="actions">
    <button type="button" class="save" id="saveBtn">保存</button>
  </div>
</div>

<script>
/* ====== 設定（必要に応じて変更） ====== */
// 入力不可の曜日（0=日,1=月,…,6=土）
const DISABLE_WEEKDAYS = [0]; // 例：日曜を不可
// デフォルト値（新規生成時に適用）
const DEFAULT_MORNING = ''; // 例：'10'
const DEFAULT_AFTERNOON = ''; // 例：'5'
// 入力制約：整数かつ 0〜MAX_CAP
const MAX_CAP = 9999;
// 個別不可日（'YYYY-MM-DD'）
const DISABLE_DATES = []; // 例：['2025-01-01']

/* ====== 年月セレクト初期化 ====== */
(function initSelectors(){
  const yearSel = document.getElementById('yearSel');
  const monthSel = document.getElementById('monthSel');
  const now = new Date();
  const startYear = now.getFullYear() - 1;
  const endYear = now.getFullYear() + 2;

  for(let y=startYear; y<=endYear; y++){
    const opt = document.createElement('option');
    opt.value = y; opt.textContent = `${y}年`;
    yearSel.appendChild(opt);
  }
  for(let m=1; m<=12; m++){
    const opt = document.createElement('option');
    opt.value = m; opt.textContent = `${m}月`;
    monthSel.appendChild(opt);
  }
  yearSel.value = now.getFullYear();
  monthSel.value = now.getMonth() + 1;

  updateMonthBadge();
  yearSel.addEventListener('change', updateMonthBadge);
  monthSel.addEventListener('change', updateMonthBadge);
})();

function updateMonthBadge(){
  const y = document.getElementById('yearSel').value;
  const m = document.getElementById('monthSel').value;
  document.getElementById('monthBadge').textContent = `${y}年${m}月`;
}

/* ====== 行生成 ====== */
document.getElementById('decideBtn').addEventListener('click', buildMonthTable);

function buildMonthTable(){
  clearMsg();
  const body = document.getElementById('capBody');
  body.innerHTML = '';

  const year = parseInt(document.getElementById('yearSel').value, 10);
  const month = parseInt(document.getElementById('monthSel').value, 10);
  const lastDate = new Date(year, month, 0).getDate();

  for(let d=1; d<=lastDate; d++){
    const date = new Date(year, month-1, d);
    const iso = toISO(date);
    const dow = date.getDay();
    const row = document.createElement('tr');

    // 日曜/不可日ハイライト
    const isDisabled = DISABLE_WEEKDAYS.includes(dow) || DISABLE_DATES.includes(iso);
    if(isDisabled) row.classList.add('sunRow','disabled');

    // 日付
    const tdDate = document.createElement('td');
    tdDate.className = 'dateCell';
    tdDate.textContent = iso;
    row.appendChild(tdDate);

    // 曜日
    const tdDow = document.createElement('td');
    tdDow.className = 'dowCell';
    tdDow.textContent = ['日','月','火','水','木','金','土'][dow];
    row.appendChild(tdDow);

    // 午前
    const tdAm = document.createElement('td');
    tdAm.className = 'capCell';
    const am = document.createElement('input');
    am.type = 'number';
    am.min = 0; am.max = MAX_CAP; am.step = 1;
    am.className = 'capInput';
    am.placeholder = '—';
    am.value = DEFAULT_MORNING;
    tdAm.appendChild(am);
    row.appendChild(tdAm);

    // 午後
    const tdPm = document.createElement('td');
    tdPm.className = 'capCell';
    const pm = document.createElement('input');
    pm.type = 'number';
    pm.min = 0; pm.max = MAX_CAP; pm.step = 1;
    pm.className = 'capInput';
    pm.placeholder = '—';
    pm.value = DEFAULT_AFTERNOON;
    tdPm.appendChild(pm);
    row.appendChild(tdPm);

    // 入力不可化
    if(isDisabled){
      am.disabled = true; pm.disabled = true;
      am.title = '選択不可'; pm.title = '選択不可';
    }

    body.appendChild(row);
  }
}

/* ====== 保存（検証→JSON表示） ====== */
document.getElementById('saveBtn').addEventListener('click', () => {
  clearMsg();

  const y = parseInt(document.getElementById('yearSel').value, 10);
  const m = parseInt(document.getElementById('monthSel').value, 10);
  const rows = [...document.querySelectorAll('#capBody tr')];

  const payload = [];
  for(const r of rows){
    const dateStr = r.children[0].textContent.trim();
    const amInput = r.children[2].querySelector('input');
    const pmInput = r.children[3].querySelector('input');
    const isDisabled = r.classList.contains('disabled');

    // 検証：入力可能行のみ
    if(!isDisabled){
      const amVal = amInput.value === '' ? null : Number(amInput.value);
      const pmVal = pmInput.value === '' ? null : Number(pmInput.value);

      // 数値検証
      if(amVal !== null && (!Number.isInteger(amVal) || amVal < 0 || amVal > MAX_CAP)){
        return showError(`【${dateStr} 午前】は 0〜${MAX_CAP} の整数で入力してください。`);
      }
      if(pmVal !== null && (!Number.isInteger(pmVal) || pmVal < 0 || pmVal > MAX_CAP)){
        return showError(`【${dateStr} 午後】は 0〜${MAX_CAP} の整数で入力してください。`);
      }

      payload.push({
        date: dateStr,
        morning_cap: amVal,   // null は未設定
        afternoon_cap: pmVal
      });
    }else{
      // 不可日は送信しない（必要なら含める仕様に変更可能）
      payload.push({
        date: dateStr,
        morning_cap: null,
        afternoon_cap: null,
        disabled: true
      });
    }
  }

  // 成功表示（実運用では API 送信）
  const json = JSON.stringify({
    year: y, month: m,
    capacity: payload
  }, null, 2);

  showSuccess('保存内容（JSON）:\n' + json);

  // 例：送信するなら
  // fetch('/api/capacity/month', {
  //   method: 'POST',
  //   headers: {'Content-Type': 'application/json'},
  //   body: json
  // }).then(res => res.ok ? showSuccess('保存しました') : showError('保存に失敗しました'));
});

/* ====== ユーティリティ ====== */
function toISO(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function showError(msg){
  const box = document.getElementById('errorBox');
  box.textContent = msg;
  box.style.display = 'block';
}
function showSuccess(msg){
  const box = document.getElementById('successBox');
  box.textContent = msg;
  box.style.display = 'block';
}
function clearMsg(){
  document.getElementById('errorBox').style.display = 'none';
  document.getElementById('successBox').style.display = 'none';
}

/* 初回：今月で表作成 */
buildMonthTable();
</script>
</body>
</html>
